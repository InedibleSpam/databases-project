let EastWestDB = require('mysql');

let dbconn =  EastWestDB.createConnection({
    host: "localhost",
    user: "root",
    password: "poo.py",
    database: "EastWest"

});

dbconn.connect(function(error) {
    if (error) throw error;
    console.log("Connected");
});

//All of these are meant to be used for the filter buttons and inserted into the generalSortFunction

//Returns number
function setPriceGreaterThan(price_greater_than){
    return price_greater_than;
}
//Returns number
function setPriceLessThan(price_less_than){
    return price_less_than;
}
//Returns string
function setSeatClass(seat_class){
    return seat_class;
}   

function queryDB(sql, values = []){
    return new Promise((resolve, reject) => {
        dbconn.query(sql, values, (error, results) => {
        if (error){
            return reject(error);
        }else{
            resolve(results);
            return true;
        }
    });
    });
}


async function GeneralSortFunction(in_airport, out_airport ,departure_time, arrival_time, date, price_greater_than = null, price_less_than = null, seat_class = null){

    if (price_greater_than != null){
        value_list.push(price_greater_than);
        column_list.push("price > ? ");
    }
    if(price_less_than != null){
        value_list.push(price_less_than);
        column_list.push("price < ? ");
    }
    if(seat_class != null){
        value_list.push(seat_class);
        column_list.push("seat_class = ? ");
    };

    const normal_value_list = [in_airport, out_airport, date, departure_time, arrival_time];
    const filter_value_list = [ ];
    const filter_column_list = [ ];

    sql = "SELECT price, class, logs.date, logs.departure_time, logs.arrival_time FROM ticket inner join logs ON ticket.log_id = logs.log_id WHERE in_airport = ? and out_airport = ? and logs.date = ? and logs.departure_time = ? and logs.arrival_time = ?"

    if (filter_value_list.length >0 && filter_column_list.length >0 && filter_value_list.length == filter_column_list.length){
        sql += " and ";
        for (let column = 0; column < column_list.length; column++){
            sql += column_list[column];
            if (column < value_list.length-1){
                sql += " and ";
            }
        }

        
    }
    let flights = await queryDB(sql, normal_value_list.concat(filter_value_list));
    return flights;
}



//console.log(GeneralSortFunction(2, 1, '11:00:00', '14:30:00', '2025-12-15'));

